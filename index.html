<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ArtVin Cup</title>

<style>
body {
    margin: 0;
    background: #f7f9fb;
    font-family: "Segoe UI", Arial, sans-serif;
    overflow: hidden;
}

header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 100px;
    background: #0069d9;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    box-shadow: 0 3px 10px rgba(0,0,0,.25);
    z-index: 10;
}

.header-title {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-title h1 {
    margin: 0;
    font-size: 26px;
    font-weight: 800;
}

.header-title img {
    height: 80px;
    width: auto;
    border-radius: 6px;
    background: #fff;
    padding: 4px;
}

.stream-select {
    font-size: 16px;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    color: #007bff;
    background: #fff;
    cursor: pointer;
    font-weight: 600;
}

main {
    position: absolute;
    top: 100px;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 14px;
    box-sizing: border-box;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 14px;
}

.table-box {
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.15);
    height: 100%; /* фиксируем высоту под grid */
}

.table-title {
    background: #007bff;
    color: #fff;
    text-align: center;
    padding: 12px;
    font-size: 20px;
    font-weight: 900;
}

.apparatus {
    background: #eef4ff;
    padding: 12px;
    text-align: center;
    font-size: 20px;
    font-weight: 800;
    border-bottom: 1px solid #dce2e9;
}

table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed; /* фиксированные колонки */
}

th, td {
    border: 1px solid #dce2e9;
    padding: 14px;
    text-align: center;
    font-size: 18px;
    font-weight: 700;
    overflow-wrap: break-word;
}

thead, tbody tr {
    display: table;
    width: 100%;
    table-layout: fixed;
}

tbody {
    display: block;  /* позволяет динамически регулировать высоту строк */
    overflow: hidden; /* скролл убираем */
}

tbody tr:nth-child(even) td {
    background: #f8fafc;
}

.gold td {
    background: #ffe680 !important;
    font-weight: 900 !important;
}

@media (max-width: 900px) {
    main {
        grid-template-columns: 1fr;
        padding: 10px;
    }
    th, td { font-size: 16px; padding: 8px; }
    .apparatus { font-size: 18px; padding: 10px; }
}

@media (min-width: 1800px) {
    th, td { font-size: 22px; padding: 18px; }
    .table-title { font-size: 26px; }
    .apparatus { font-size: 24px; }
}
</style>
</head>

<body>
<header>
    <div class="header-title">
        <h1>ArtVin Cup</h1>
        <img src="https://raw.githubusercontent.com/Miner229/table-site/main/ArtVinCup.jpg"
             alt="Логотип"
             onerror="this.src='https://miner229.github.io/table-site/ArtVinCup.jpg';">
    </div>
    <select id="streamSelect" class="stream-select">
        <option value="" disabled selected>Выберите поток</option>
        <option value="1">поток 1</option>
        <option value="2">поток 2</option>
        <option value="3">поток 3</option>
        <option value="4">поток 4</option>
        <option value="5">поток 5</option>
        <option value="6">поток 6</option>
        <option value="7">поток 7</option>
    </select>
</header>

<main id="tables"></main>

<script>
    const SHEET_ID = "1NCLssbli5uUVMNLn88zw8n2RdzHTaZrumR9AP0Zvd9w";

    const STREAMS = {
      1: { sheet: "поток 1", ranges: ["A2:B9","D2:E13","G2:H14","A16:B28","D16:E27","G16:H28"] },
      2: { sheet: "поток 2", ranges: ["A3:B16","D3:E15","G3:H14","A18:B29","D17:E26","G17:H26"] },
      3: { sheet: "поток 3", ranges: ["A2:B14","D2:E13","A16:B28","D16:E28"] },
      4: { sheet: "поток 4", ranges: ["A3:B15","D3:E16","G3:H14","A18:B31","D18:E31","G18:H31","A33:B44"] },
      5: { sheet: "поток 5", ranges: ["A3:B14","D3:E13","G3:H14","A17:B27","D17:E27"] },
      6: { sheet: "поток 6", ranges: ["A2:B8","D2:E8","G2:H8"] },
      7: { sheet: "поток 7", ranges: ["A2:B13","D2:E14","A16:B27","D16:E26"] }
    };

    const container = document.getElementById("tables");
    const select = document.getElementById("streamSelect");

    const PAGE_SIZE = 2;
    const ROTATE_MS = 20000;
    const REFRESH_MS = 20000;

    let allTables = [];
    let pageIndex = 0;
    let rotateTimer = null;
    let refreshTimer = null;
    let currentStream = null;
    let loadGeneration = 0;

    function parseCSV(text) {
      return text
        .trim()
        .split(/\r?\n/)
        .map(line =>
          line
            .split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
            .map(v => v.replace(/^"+|"+$/g, "").trim())
        );
    }

    function buildCsvUrl(sheet, range) {
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq` +
             `?tqx=out:csv&sheet=${encodeURIComponent(sheet)}` +
             `&range=${range}&cacheBust=${Date.now()}`;
    }

    // ------------ ГЛАВНОЕ: улучшенная загрузка таблицы ------------
    async function loadTable(sheet, range, index, gen) {
      const res = await fetch(buildCsvUrl(sheet, range));
      const text = await res.text();
      if (gen !== loadGeneration) return null;

      const rawRows = parseCSV(text);
      const rows = rawRows.filter(r => r.some(c => c !== ""));

      if (!rows.length) {
        return `
          <div class="table-box">
            <div class="table-title">Таблица ${index}</div>
            <div class="apparatus">Нет данных</div>
          </div>`;
      }

      // --- 1) Аппарат (первая строка диапазона)
      let apparatusText = rows[0].join(" ").trim();
      apparatusText = apparatusText
        .replace(/фио/gi, "")
        .replace(/оценка/gi, "")
        .trim();
      if (!apparatusText) apparatusText = "Снаряд";

      // --- 2) Находим строку заголовков
      let headerIndex = rows.findIndex(r =>
        r[0] && /фио/i.test(r[0]) &&
        r[1] && /оценка/i.test(r[1])
      );

      if (headerIndex === -1) headerIndex = 1; // fallback

      let headerRow = rows[headerIndex] || [];
      let nameHeader = headerRow[0] || "ФИО";
      let scoreHeader = headerRow[1] || "Оценка";

      // --- 3) Участники
      let participants = rows.slice(headerIndex + 1);

      // ищем максимальную оценку
      let maxScore = -Infinity;
      participants.forEach(r => {
        const raw = (r[1] || "").replace(",", ".");
        const num = parseFloat(raw);
        if (!isNaN(num) && num > maxScore) maxScore = num;
      });

      let html = `
        <div class="table-box">
          <div class="table-title">Таблица ${index}</div>
          <div class="apparatus">${apparatusText}</div>
          <table>
            <thead>
              <tr>
                <th>${nameHeader}</th>
                <th>${scoreHeader}</th>
              </tr>
            </thead>
            <tbody>
      `;

      participants.forEach(row => {
        const fio = (row[0] || "").trim();
        const scoreText = (row[1] || "").trim();
        if (!fio && !scoreText) return;

        const num = parseFloat(scoreText.replace(",", "."));
        const isGold = !isNaN(num) && num === maxScore;

        html += `
          <tr class="${isGold ? "gold" : ""}">
            <td>${fio}</td>
            <td>${scoreText}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      return html;
    }

    function renderPage() {
      if (!allTables.length) {
        container.innerHTML = "<p style='text-align:center;color:#555;'>Нет данных для этого потока</p>";
        return;
      }

      const totalPages = Math.ceil(allTables.length / PAGE_SIZE);
      if (pageIndex >= totalPages) pageIndex = 0;

      const start = pageIndex * PAGE_SIZE;
      const slice = allTables.slice(start, start + PAGE_SIZE);

      container.style.gridTemplateColumns = `repeat(${Math.min(slice.length, 2)}, 1fr)`;
      container.innerHTML = slice.join("");

      pageIndex = (pageIndex + 1) % totalPages;
    }

    async function refreshTables() {
      if (!currentStream) return;

      const cfg = STREAMS[currentStream];
      const gen = ++loadGeneration;
      const tables = [];

      for (let i = 0; i < cfg.ranges.length; i++) {
        try {
          const html = await loadTable(cfg.sheet, cfg.ranges[i], i + 1, gen);
          tables.push(html);
        } catch (e) {
          tables.push(`
            <div class="table-box">
              <div class="table-title">Таблица ${i + 1}</div>
              <div style="padding:12px;text-align:center;color:#c00;">Ошибка загрузки</div>
            </div>
          `);
        }
      }

      if (gen !== loadGeneration) return;
      allTables = tables;
    }

    async function renderStream(stream) {
      const cfg = STREAMS[stream];
      currentStream = stream;

      if (!cfg) {
        container.innerHTML = "<p style='text-align:center;color:#c00;'>Нет данных</p>";
        return;
      }

      container.innerHTML = "<p style='text-align:center;color:#555;'>Загрузка...</p>";

      clearInterval(rotateTimer);
      clearInterval(refreshTimer);

      const gen = ++loadGeneration;
      const tables = [];

      for (let i = 0; i < cfg.ranges.length; i++) {
        try {
          const html = await loadTable(cfg.sheet, cfg.ranges[i], i + 1, gen);
          tables.push(html);
        } catch (e) {
          tables.push(`
            <div class="table-box">
              <div class="table-title">Таблица ${i + 1}</div>
              <div style="padding:12px;text-align:center;color:#c00;">Ошибка загрузки</div>
            </div>
          `);
        }
      }

      if (gen !== loadGeneration) return;

      allTables = tables;
      pageIndex = 0;
      renderPage();

      if (allTables.length > PAGE_SIZE) {
        rotateTimer = setInterval(renderPage, ROTATE_MS);
      }

      refreshTimer = setInterval(refreshTables, REFRESH_MS);
    }

    select.addEventListener("change", () => {
      const s = select.value;
      if (s) renderStream(s);
    });
  </script>
</body>
</html>
